<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://smartplugin.youbora.com/v6/js/adapters/chromecastcaf/6.1.0/sp.min.js"></script>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Open+Sans:300,400);

        #player {
            --progress-color: rgba(255, 255, 255, 0.2);
            --splash-image: url("assets/logo.svg");
            --splash-background: #1A2237;
            --splash-color: #1A2237;
            --splash-size: 80%;
            --logo-image: url("assets/logo.svg");
            --logo-background: #1A2237;
            --font-family: 'Open Sans', sans-serif;
        }
    </style>
</head>
<body>
<cast-media-player id="player"></cast-media-player>
<script>
    const youboraAccountCode = "tdcdev";
    const schema = "1.0";
    const form = "cjson";
    const apiUrl = "http://data.userprofile.community.theplatform.eu/userprofile/data/UserListItem";
    const licenceAccountUrl = "http://access.auth.theplatform.com/data/Account/2693468579";
    const licenseUrl = "https://widevine.entitlement.theplatform.eu/wv/web/ModularDrm?schema=1.0";
    const protectionSystem = "widevine";

    let token, pid, username, byAboutId, byUserListId, postSettings, getSettings, guid, contentId,
        timestamp, platform, contentResource;
    let lastValue = 0;

    const context = cast.framework.CastReceiverContext.getInstance();
    const playbackConfig = new cast.framework.PlaybackConfig();

    if (typeof youbora !== "undefined" && typeof youbora.adapters.ChromecastCAF !== "undefined") {
        const player = context.getPlayerManager();
        window.plugin = new youbora.Plugin({accountCode: youboraAccountCode});
        plugin.setAdapter(new youbora.adapters.ChromecastCAF(player))
    }

    context.getPlayerManager().addEventListener(
        cast.framework.events.EventType.TIME_UPDATE, (event) => {
            const value = Math.floor(event.currentMediaTime);
            if (value % 10 === 0 && value !== lastValue) {
                lastValue = value;

                const queueManager = context.getPlayerManager().getQueueManager();
                const currentItemMedia = queueManager.getCurrentItem().media;

                byAboutId = currentItemMedia.customData.aboutId;
                byUserListId = currentItemMedia.customData.userListId;
                guid = currentItemMedia.customData.guid;

                getSettings = {
                    async: true,
                    crossDomain: true,
                    method: "GET",
                    url: apiUrl + "/?schema=" + schema + "&form=" + form + "&account=" + licenceAccountUrl + "&token=" + token + "&byAboutId=" + byAboutId + "&byUserListId=" + byUserListId,
                };

                postSettings = {
                    async: true,
                    crossDomain: true,
                    url: apiUrl + "/?schema=" + schema + "&form=" + form + "&account=" + licenceAccountUrl + "&token=" + token,
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    processData: false,
                    data: "{\"$xmlns\":{\"pluserlistitem\":\"" + apiUrl + "\",\"tdc\":\"http://tdc.dk/fields\"},\"userListId\":\"" + byUserListId + "\",\"aboutId\":\"" + byAboutId + "\",\"description\":\"" + guid + "\",\"tdc$additionalData\":{\"timestamp\":\"" + value + "\"}}"
                };

                $.ajax(getSettings).done((response) => {
                    if (response.responseCode === 403) {
                        return
                    }

                    const res = JSON.parse(response);
                    if (response && res['entries'] && res['entries'].length) {
                        const entry = res.entries[0];
                        const dataToSend = "{\"$xmlns\":{\"pluserlistitem\":\"" + apiUrl + "\",\"tdc\":\"http://tdc.dk/fields\"},\"id\":\"" + entry.id + "\",\"title\":\"" + entry.title + "\",\"description\":\"" + guid + "\",\"tdc$additionalData\":{\"timestamp\":\"" + value + "\"}}"
                        const updateData = {
                            async: true,
                            crossDomain: true,
                            url: apiUrl + "/?schema=" + schema + "&form=" + form + "&account=" + licenceAccountUrl + "&token=" + token,
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            processData: false,
                            data: dataToSend,
                        };
                        $.ajax(updateData).done((res) => {});
                    } else {
                        $.ajax(postSettings).done((res) => {
                        });
                    }
                });
            }
        });


    playbackConfig.licenseUrl = licenseUrl;
    playbackConfig.protectionSystem = protectionSystem;

    playbackConfig.licenseRequestHandler = requestInfo => {
        const challenge = btoa(String.fromCharCode.apply(null, new Uint8Array(requestInfo.content)));
        requestInfo.content = JSON.stringify({getWidevineLicense: {releasePid: pid, widevineChallenge: challenge}});
        requestInfo.headers['content-type'] = "application/json;charset=UTF-8";
        requestInfo.url = requestInfo.url + "&account=" + licenceAccountUrl + "&form=json&token=" + token;
    };

    playbackConfig.licenseHandler = data => {
        const response = JSON.parse(String.fromCharCode.apply(null, new Uint8Array(data)));
        const license = response.getWidevineLicenseResponse.license;
        const raw = window.atob(license);
        const rawLength = raw.length;
        const array = new Uint8Array(new ArrayBuffer(rawLength));

        for (var i = 0; i < rawLength; i++) {
            array[i] = raw.charCodeAt(i);
        }

        return array;
    };

    context.getPlayerManager().setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD, loadRequestData => {
            token = loadRequestData.media.customData.token;
            pid = loadRequestData.media.customData.releasePid;
            username = loadRequestData.media.customData.userId;
            byAboutId = loadRequestData.media.customData.aboutId;
            byUserListId = loadRequestData.media.customData.userListId;
            guid = loadRequestData.media.customData.guid;
            
            loadRequestData.media.contentId = "https://r5plwq1y9j.execute-api.eu-central-1.amazonaws.com/production/proxyCdn?releasePid=eEcBrbb65np5&token=uM2TPCnEhZp40wM80YvA8TC80LB08LCK&cdnType=2";
            contentId = loadRequestData.media.contentId;
            timestamp = loadRequestData.media.currentTime;
            platform = loadRequestData.media.customData.platform;

            $.ajax({
                async: false,
                method: "GET",
                processData: false,
                url: loadRequestData.media.contentId + '&format=SMIL',
            }).done((response) => {
                if (response) {
                    const xml = $.parseXML(response);
                    contentResource = $(xml).find('video').attr('src');
                }
            });

            if (typeof youbora !== "undefined" && typeof youbora.adapters.ChromecastCAF !== "undefined") {
                plugin.setOptions(
                    {
                        'username': username,
                        'parse.hls': true,
                        'parse.CDNNode': true,
                        'content.resource': contentResource,
                        'additionalData': {timestamp},
                        'extraparam.3': platform ? platform : 'unknown'
                    }
                );
            }

            return loadRequestData;
        });
    context.start({playbackConfig: playbackConfig});
</script>
</body>
</html>
