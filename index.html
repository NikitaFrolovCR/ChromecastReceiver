<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://smartplugin.youbora.com/v6/js/adapters/chromecastcaf/6.1.0/sp.min.js"></script>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Open+Sans:300,400);

        #player {
            --progress-color: rgba(255, 255, 255, 0.2);
            --splash-image: url("assets/logo.svg");
            --splash-background: #1A2237;
            --splash-color: #1A2237;
            --logo-image: url("assets/logo.svg");
            --logo-background: #1A2237;
            --font-family: 'Open Sans', sans-serif;
        }
    </style>
</head>
<body>
<cast-media-player id="player"></cast-media-player>
<script>
    const account = "Blockbuster Nordic";
    const schema = "1.0";
    const form = "cjson";

    const context = cast.framework.CastReceiverContext.getInstance();

    if (typeof youbora !== "undefined" && typeof youbora.adapters.ChromecastCAF !== "undefined") {
        window.plugin = new youbora.Plugin({accountCode: 'tdcdev'});

        const player = context.getPlayerManager();
        plugin.setAdapter(new youbora.adapters.ChromecastCAF(player))
    }

    let lastValue = 0;
    context.getPlayerManager().addEventListener(
        cast.framework.events.EventType.TIME_UPDATE, (event) => {
            const value = Math.floor(event.currentMediaTime);
            if (value % 10 === 0 && value !== lastValue) {
                lastValue = value;

                const queueManager = context.getPlayerManager().getQueueManager();
                const currentItemMedia = queueManager.getCurrentItem().media;

                byAboutId = currentItemMedia.customData.aboutId;
                byUserListId = currentItemMedia.customData.userListId;
                guid = currentItemMedia.customData.guid;

                deleteSettings = {
                    async: true,
                    crossDomain: true,
                    url: "http://data.userprofile.community.theplatform.eu/userprofile/data/UserListItem/?schema="
                        + schema + "&form=" + form + "&account=" + account + "&token=" + token + "&byAboutId="
                        + byAboutId + "&byUserListId=" + byUserListId,
                    method: "DELETE"
                };

                postSettings = {
                    async: true,
                    crossDomain: true,
                    url: "http://data.userprofile.community.theplatform.eu/userprofile/data/UserListItem/?schema="
                        + schema + "&form=" + form + "&account=" + "http://access.auth.theplatform.com/data/Account/2693468579" + "&token=" + token,
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    processData: false,
                    data: "{\"$xmlns\":{\"pluserlistitem\":\"http://xml.theplatform.com/userprofile/data/UserListItem\",\"tdc\":\"http://tdc.dk/fields\"},\"userListId\":\"" + byUserListId + "\",\"aboutId\":\"" + byAboutId + "\",\"description\":\"" + guid + "\",\"tdc$additionalData\":{\"timestamp\":\"" + value + "\"}}"
                };

                $.ajax(deleteSettings)
                    .done((response) => {
                        if (response.responseCode !== 403) {
                            $.ajax(postSettings).done((res) => {});
                        }
                    });
            }
        });


    let token, pid, username, byAboutId, byUserListId, deleteSettings, postSettings, guid, contentId, timestamp, contentResource;
    const playbackConfig = new cast.framework.PlaybackConfig();

    playbackConfig.licenseUrl = 'https://widevine.entitlement.theplatform.eu/wv/web/ModularDrm?schema=1.0';
    playbackConfig.protectionSystem = 'widevine';

    playbackConfig.licenseRequestHandler = requestInfo => {
        const challenge = btoa(String.fromCharCode.apply(null, new Uint8Array(requestInfo.content)));
        requestInfo.content = JSON.stringify({getWidevineLicense: {releasePid: pid, widevineChallenge: challenge}});
        requestInfo.headers['content-type'] = "application/json;charset=UTF-8";
        requestInfo.url = requestInfo.url + "&account=http://access.auth.theplatform.com/data/Account/2693468579&form=json&token=" + token;
        //requestInfo.withCredentials = true;
    };

    //Manage License URL response and modify before use it.
    playbackConfig.licenseHandler = data => {
        const response = JSON.parse(String.fromCharCode.apply(null, new Uint8Array(data)));
        const license = response.getWidevineLicenseResponse.license;
        const raw = window.atob(license);
        const rawLength = raw.length;
        const array = new Uint8Array(new ArrayBuffer(rawLength));

        for (var i = 0; i < rawLength; i++) {
            array[i] = raw.charCodeAt(i);
        }

        return array;
    };

    // Collect loadRequestData to get the pid and token needed by licenseURL request.
    context.getPlayerManager().setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD, loadRequestData => {
            token = loadRequestData.media.customData.token;
            pid = loadRequestData.media.customData.releasePid;
            username = loadRequestData.media.customData.email;
            byAboutId = loadRequestData.media.customData.aboutId;
            byUserListId = loadRequestData.media.customData.userListId;
            guid = loadRequestData.media.customData.guid;
            contentId = loadRequestData.media.contentId;
            timestamp = loadRequestData.media.currentTime;

            $.ajax({
                async: false,
                method: "GET",
                processData: false,
                url: loadRequestData.media.contentId + '&format=SMIL',
            }).done((response)=> {
                console.log($.parseXML(response));
            });

            if (typeof youbora !== "undefined" && typeof youbora.adapters.ChromecastCAF !== "undefined") {
                plugin.setOptions(
                    {
                        'username': username,
                        'parse.hls': true,
                        'parse.CDNNode': true,
                        'content.resource': '',
                        'additionalData': {timestamp}
                    }
                );
            }

            return loadRequestData;
        });
    context.start({playbackConfig: playbackConfig});
</script>
</body>
</html>
